import{j as e}from"./ui-vendor-D6k6xAJg.js";import{r as t}from"./react-vendor-CbTYwD9p.js";import{a as ie,u as ne,b as oe}from"./router-vendor-BssJdvT9.js";import{s as p,a as n}from"./index-CWAcGGyY.js";import{B as l}from"./button-ro640sRo.js";import{D as le,a as ce,b as de,c as me,d as he,e as pe}from"./dialog-BrE8jvkE.js";import{I as fe}from"./input-DlTyRBPh.js";import{L as ue}from"./label-3xwd5eha.js";import{B as F}from"./BrandTemplateRenderer-BmYMQXKl.js";import{C as xe,a as ge}from"./CVEditor-DCuu687y.js";import{T as be,a as je,b as O,c as z}from"./tabs-D4HRQBSG.js";import{l as ve,P as V}from"./export-features-Bjk4ojhA.js";import{C as we}from"./chevron-left-BMjbAc_U.js";import{F as I}from"./file-text-DjzqkRut.js";import{S as Se,C as ye}from"./trash-2-BmeZmT5Y.js";import{L as q}from"./loader-circle-Etq7a_Nb.js";import{S as Ne}from"./share-2-JdMFhlJo.js";import{D as ke}from"./download-C1d5iczR.js";import{U as Ce}from"./user-jdNjT8Fw.js";import{C as De}from"./check-Cp6OSBFl.js";import"./supabase-vendor-CYMOQS5a.js";import"./query-vendor-CKaEIWod.js";import"./ExecutiveTemplate-B4Hf2As9.js";import"./card-CfRzuJdW.js";import"./badge-DYFFvGV6.js";import"./separator-C1i2gjVs.js";import"./external-link-418F5hIn.js";import"./briefcase-B833yQK2.js";import"./calendar-BAG2bnGU.js";import"./award-DpAKLtWf.js";import"./textarea-DMLWv3zQ.js";import"./select-D-FesbXe.js";import"./index-2c6_cF8I.js";import"./plus-htkYI_UT.js";import"./save-BtpEs3Fh.js";function cr(){var _;const{id:j}=ie(),f=ne(),[U]=oe(),m=U.get("cv"),[i,$]=t.useState(null),[c,D]=t.useState(null),[A,E]=t.useState(!0),[v,H]=t.useState("brand"),[P,M]=t.useState(!1),[W,w]=t.useState(!1),[S,R]=t.useState(!1),[y,L]=t.useState(!1),[N,G]=t.useState(""),[J,k]=t.useState(!1),u=t.useRef(null),X=r=>{if(!r)return null;if(typeof r=="string")try{const a=JSON.parse(r);return a&&typeof a=="object"?a:null}catch(a){return console.warn("Failed to parse brand raw_context",a),null}return typeof r=="object"?r:null};t.useEffect(()=>{K(),m&&Q()},[j,m]);const K=async()=>{try{const{data:r,error:a}=await p.from("brands").select("*").eq("id",j).single();if(a)throw a;$({...r,raw_context:X(r.raw_context)})}catch(r){console.error("Load error:",r),n.error("Failed to load brand"),f("/dashboard")}finally{m||E(!1)}},Q=async()=>{if(m)try{const{data:r,error:a}=await p.from("cvs").select("*").eq("id",m).single();if(a)throw a;D(r)}catch(r){console.error("CV load error:",r),n.error("Failed to load CV")}finally{E(!1)}};if(A)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx("div",{className:"text-muted-foreground",children:"Loading..."})});if(!i)return null;const T=((_=i.raw_context)==null?void 0:_.markdown)||`# Brand Rider

Content not available.`,Y=async()=>{R(!0),k(!1);try{const{data:r,error:a}=await p.from("shares").select("*").eq("target_id",i.id).eq("kind","brand").eq("user_id",i.user_id).maybeSingle();if(a)throw a;let o=r;if(!o){const s=crypto.randomUUID().replace(/-/g,""),{data:x,error:h}=await p.from("shares").insert({kind:"brand",target_id:i.id,token:s,user_id:i.user_id}).select().single();if(h)throw h;o=x}const d=`${window.location.origin}/share/${o.token}`;if(G(d),w(!0),navigator.share)try{await navigator.share({title:i.title||"Brand Rider",text:i.tagline||void 0,url:d})}catch(s){(s==null?void 0:s.name)!=="AbortError"&&console.warn("Web Share failed:",s)}else await navigator.clipboard.writeText(d),n.success("Share link copied to clipboard"),k(!0)}catch(r){console.error("Share error:",r),n.error((r==null?void 0:r.message)||"Unable to prepare share link")}finally{R(!1)}},Z=async()=>{if(N)try{await navigator.clipboard.writeText(N),n.success("Share link copied"),k(!0)}catch(r){console.error("Copy error:",r),n.error("Failed to copy link")}},ee=async()=>{if(u.current){L(!0);try{const{html2canvas:r,jsPDF:a}=await ve(),o=await r(u.current,{scale:2,useCORS:!0}),d=o.toDataURL("image/png"),s=new a("p","mm","a4"),x=s.internal.pageSize.getWidth(),h=s.internal.pageSize.getHeight(),B=x,g=o.height*x/o.width;let b=g,C=0;for(s.addImage(d,"PNG",0,C,B,g),b-=h;b>0;)C=b-g,s.addPage(),s.addImage(d,"PNG",0,C,B,g),b-=h;const te=`${i.title||"brand"}-rider.pdf`;s.save(te),n.success("Exported brand as PDF")}catch(r){console.error("Export error:",r);const a=(r==null?void 0:r.message)===V?V:(r==null?void 0:r.message)||"Failed to export PDF";n.error(a)}finally{L(!1)}}},re=v==="brand"?"Brand Rider":"Professional CV",ae=r=>{D(r)},se=async r=>{const{error:a}=await p.from("cvs").update({title:r.title||null,summary:r.summary||null,experience:r.experience||[],skills:r.skills||[],links:r.links||[],format_preset:r.format||null,updated_at:new Date().toISOString()}).eq("id",c.id);if(a)throw a};return e.jsxs("div",{className:"min-h-screen",children:[e.jsx("div",{className:"bg-surface/95 backdrop-blur-sm border-b border-border sticky top-0 z-50",children:e.jsx("div",{className:"container mx-auto px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(l,{variant:"ghost",size:"sm",onClick:()=>f("/dashboard"),children:[e.jsx(we,{className:"w-4 h-4 mr-2"}),"Back to Dashboard"]}),e.jsxs("div",{className:"flex gap-2",children:[c&&e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>f(`/cv/${c.id}`),children:[e.jsx(I,{className:"w-4 h-4 mr-2"}),"View CV Separately"]}),e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>{v==="brand"?f(`/brand/${j}/edit`):M(!P)},children:[e.jsx(Se,{className:"w-4 h-4 mr-2"}),"Edit ",re]}),e.jsxs(l,{variant:"outline",size:"sm",onClick:Y,disabled:S,children:[S?e.jsx(q,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(Ne,{className:"w-4 h-4 mr-2"}),S?"Preparing":"Share"]}),e.jsxs(l,{variant:"outline",size:"sm",onClick:ee,disabled:y,children:[y?e.jsx(q,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(ke,{className:"w-4 h-4 mr-2"}),y?"Exporting":"Export PDF"]})]})]})})}),c?e.jsx("div",{className:"container mx-auto px-6 py-8",children:e.jsxs(be,{value:v,onValueChange:H,className:"w-full",children:[e.jsxs(je,{className:"grid w-full grid-cols-2 mb-8",children:[e.jsxs(O,{value:"brand",className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"w-4 h-4"}),"Brand Rider"]}),e.jsxs(O,{value:"cv",className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-4 h-4"}),"Professional CV"]})]}),e.jsx(z,{value:"brand",children:e.jsx(F,{ref:u,brand:i,markdown:T})}),e.jsx(z,{value:"cv",children:P?e.jsx(xe,{cv:c,onChange:ae,onSave:se}):e.jsx(ge,{cv:c})})]})}):e.jsx(F,{ref:u,brand:i,markdown:T}),e.jsx(le,{open:W,onOpenChange:w,children:e.jsxs(ce,{children:[e.jsxs(de,{children:[e.jsx(me,{children:"Share brand"}),e.jsx(he,{children:"Share a read-only link to this brand presentation with collaborators."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ue,{children:"Share link"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fe,{value:N,readOnly:!0}),e.jsx(l,{variant:"outline",size:"icon",onClick:Z,children:J?e.jsx(De,{className:"w-4 h-4"}):e.jsx(ye,{className:"w-4 h-4"})})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Anyone with this link can view the latest version of your Brand Rider."})]}),e.jsx(pe,{children:e.jsx(l,{onClick:()=>w(!1),children:"Done"})})]})})]})}export{cr as default};
