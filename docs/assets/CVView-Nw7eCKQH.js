import{j as e}from"./ui-vendor-C0wu6Ixu.js";import{r as i}from"./react-vendor-CaWBk0BP.js";import{s as p,a as n}from"./index-DuW-Yr95.js";import{B as m}from"./button-D0nBzFIi.js";import{D as z,a as U,b as q,c as H,d as W,e as B}from"./dialog-CiVULkyW.js";import{I as G}from"./input-CJw-rrwE.js";import{L as u}from"./label-B9gvsU_t.js";import{T as pe}from"./textarea-CplAIQMD.js";import{S as M,a as $,b as X,c as J,d as o}from"./select-CGs7PUO_.js";import{a as ue,C as xe}from"./CVEditor-j9Sb0Xty.js";import{T as fe,a as ve,b as K,c as Q}from"./tabs-B0MGJ9wM.js";import{l as ge,P as Y}from"./export-features-Bjk4ojhA.js";import{a as je,u as ye}from"./router-vendor-CjcZkGkV.js";import{C as Se}from"./chevron-left-6zYboaaM.js";import{S as Ce,C as we}from"./trash-2-1wmQz1m8.js";import{L as _}from"./loader-circle-CVeAWNbS.js";import{S as be}from"./share-2-QnkxZJoR.js";import{D as ke}from"./download-0BoksETV.js";import{C as Ne}from"./check-Dr51VA5y.js";import"./supabase-vendor-ChaIFbZk.js";import"./query-vendor-Dx0-x9wB.js";import"./index-CS5Pkq6r.js";import"./card-CwGfeh1M.js";import"./badge-DIdVrDCd.js";import"./separator-dSadwi7O.js";import"./external-link-DOi11gbH.js";import"./user-BezrhGKr.js";import"./briefcase-BCJ8b3HT.js";import"./calendar-ZbfWttRB.js";import"./award-C9PX3u6H.js";import"./plus-dhlbengw.js";import"./save-COS1tE-7.js";function ts(){const{id:T}=je(),F=ye(),[t,y]=i.useState(null),[Z,ee]=i.useState(!0),[se,S]=i.useState(!1),[C,L]=i.useState("preview"),[ae,w]=i.useState(!1),[x,O]=i.useState(!1),[b,I]=i.useState(!1),[k,A]=i.useState(!1),[N,re]=i.useState(""),[ie,E]=i.useState(!1),[c,f]=i.useState({title:"",summary:"",format_preset:"custom",visibility:"private"}),P=i.useRef(null);i.useEffect(()=>{te()},[T]);const D=s=>{if(!s)return null;const a=Array.isArray(s.experience)?s.experience:[],l=Array.isArray(s.skills)?s.skills:[],d=Array.isArray(s.links)?s.links:[];return{...s,experience:a,skills:l,links:d,format:s.format??s.format_preset??"custom"}},te=async()=>{try{const{data:s,error:a}=await p.from("cvs").select("*").eq("id",T).single();if(a)throw a;y(D(s))}catch(s){console.error("Load error:",s),n.error("Failed to load CV"),F("/dashboard")}finally{ee(!1)}};if(Z)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx("div",{className:"text-muted-foreground",children:"Loading..."})});if(!t)return null;const le=async()=>{O(!0);try{const{data:s,error:a}=await p.from("cvs").update({title:c.title||null,summary:c.summary||null,format_preset:c.format_preset||null,visibility:c.visibility||null,updated_at:new Date().toISOString()}).eq("id",t.id).select().single();if(a)throw a;y(D(s)),n.success("CV updated"),S(!1)}catch(s){console.error("Update error:",s),n.error((s==null?void 0:s.message)||"Failed to update CV")}finally{O(!1)}},ne=s=>{y(D(s))},oe=async s=>{const{error:a}=await p.from("cvs").update({title:s.title||null,summary:s.summary||null,experience:s.experience||[],skills:s.skills||[],links:s.links||[],format_preset:s.format||null,updated_at:new Date().toISOString()}).eq("id",t.id);if(a)throw a},ce=async()=>{I(!0),E(!1);try{const{data:s,error:a}=await p.from("shares").select("*").eq("target_id",t.id).eq("kind","cv").eq("user_id",t.user_id).maybeSingle();if(a)throw a;let l=s;if(!l){const r=crypto.randomUUID().replace(/-/g,""),{data:v,error:h}=await p.from("shares").insert({kind:"cv",target_id:t.id,token:r,user_id:t.user_id}).select().single();if(h)throw h;l=v}const d=`${window.location.origin}/share/${l.token}`;if(re(d),w(!0),navigator.share)try{await navigator.share({title:t.title||"Professional CV",text:t.summary||void 0,url:d})}catch(r){(r==null?void 0:r.name)!=="AbortError"&&console.warn("Web Share failed:",r)}else await navigator.clipboard.writeText(d),n.success("Share link copied to clipboard"),E(!0)}catch(s){console.error("Share error:",s),n.error((s==null?void 0:s.message)||"Unable to prepare share link")}finally{I(!1)}},de=async()=>{if(N)try{await navigator.clipboard.writeText(N),n.success("Share link copied"),E(!0)}catch(s){console.error("Copy error:",s),n.error("Failed to copy link")}},me=async()=>{if(P.current){A(!0);try{const{html2canvas:s,jsPDF:a}=await ge(),l=await s(P.current,{scale:2,useCORS:!0}),d=l.toDataURL("image/png"),r=new a("p","mm","a4"),v=r.internal.pageSize.getWidth(),h=r.internal.pageSize.getHeight(),R=v,g=l.height*v/l.width;let j=g,V=0;for(r.addImage(d,"PNG",0,V,R,g),j-=h;j>0;)V=j-g,r.addPage(),r.addImage(d,"PNG",0,V,R,g),j-=h;const he=`${t.title||"cv"}.pdf`;r.save(he),n.success("Exported CV as PDF")}catch(s){console.error("Export error:",s);const a=(s==null?void 0:s.message)===Y?Y:(s==null?void 0:s.message)||"Failed to export PDF";n.error(a)}finally{A(!1)}}};return e.jsxs("div",{className:"min-h-screen",children:[e.jsx("div",{className:"bg-surface/95 backdrop-blur-sm border-b border-border sticky top-0 z-50",children:e.jsx("div",{className:"container mx-auto px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(m,{variant:"ghost",size:"sm",onClick:()=>F("/dashboard"),children:[e.jsx(Se,{className:"w-4 h-4 mr-2"}),"Back to Dashboard"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(m,{variant:"outline",size:"sm",onClick:()=>L(C==="edit"?"preview":"edit"),children:[e.jsx(Ce,{className:"w-4 h-4 mr-2"}),C==="edit"?"Preview":"Edit"]}),e.jsxs(m,{variant:"outline",size:"sm",onClick:ce,disabled:b,children:[b?e.jsx(_,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(be,{className:"w-4 h-4 mr-2"}),b?"Preparing":"Share"]}),e.jsxs(m,{variant:"outline",size:"sm",onClick:me,disabled:k,children:[k?e.jsx(_,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(ke,{className:"w-4 h-4 mr-2"}),k?"Exporting":"Export PDF"]})]})]})})}),e.jsx("div",{className:"container mx-auto px-6 py-8",children:e.jsxs(fe,{value:C,onValueChange:L,className:"w-full",children:[e.jsxs(ve,{className:"grid w-full grid-cols-2 mb-8",children:[e.jsx(K,{value:"preview",children:"Preview"}),e.jsx(K,{value:"edit",children:"Edit"})]}),e.jsx(Q,{value:"preview",children:e.jsx(ue,{ref:P,cv:t})}),e.jsx(Q,{value:"edit",children:e.jsx(xe,{cv:t,onChange:ne,onSave:oe})})]})}),e.jsx(z,{open:se,onOpenChange:S,children:e.jsxs(U,{children:[e.jsxs(q,{children:[e.jsx(H,{children:"Edit CV"}),e.jsx(W,{children:"Update your CV details and presentation."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"title",children:"Title"}),e.jsx(G,{id:"title",value:c.title,onChange:s=>f(a=>({...a,title:s.target.value})),placeholder:"CV title"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"summary",children:"Professional Summary"}),e.jsx(pe,{id:"summary",value:c.summary,onChange:s=>f(a=>({...a,summary:s.target.value})),placeholder:"Professional summary",className:"h-24"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Format preset"}),e.jsxs(M,{value:c.format_preset,onValueChange:s=>f(a=>({...a,format_preset:s})),children:[e.jsx($,{children:e.jsx(X,{placeholder:"Choose a format"})}),e.jsxs(J,{children:[e.jsx(o,{value:"custom",children:"Custom"}),e.jsx(o,{value:"ufc",children:"UFC"}),e.jsx(o,{value:"team",children:"Team Captain"}),e.jsx(o,{value:"military",children:"Military"}),e.jsx(o,{value:"nfl",children:"NFL"}),e.jsx(o,{value:"influencer",children:"Influencer"}),e.jsx(o,{value:"executive",children:"Executive"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Visibility"}),e.jsxs(M,{value:c.visibility,onValueChange:s=>f(a=>({...a,visibility:s})),children:[e.jsx($,{children:e.jsx(X,{placeholder:"Visibility"})}),e.jsxs(J,{children:[e.jsx(o,{value:"private",children:"Private"}),e.jsx(o,{value:"public",children:"Public"})]})]})]})]})]}),e.jsxs(B,{children:[e.jsx(m,{variant:"ghost",onClick:()=>S(!1),disabled:x,children:"Cancel"}),e.jsxs(m,{onClick:le,disabled:x,children:[x?e.jsx(_,{className:"w-4 h-4 mr-2 animate-spin"}):null,x?"Saving":"Save changes"]})]})]})}),e.jsx(z,{open:ae,onOpenChange:w,children:e.jsxs(U,{children:[e.jsxs(q,{children:[e.jsx(H,{children:"Share CV"}),e.jsx(W,{children:"Share a read-only link to this CV with potential employers or collaborators."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Share link"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{value:N,readOnly:!0}),e.jsx(m,{variant:"outline",size:"icon",onClick:de,children:ie?e.jsx(Ne,{className:"w-4 h-4"}):e.jsx(we,{className:"w-4 h-4"})})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Anyone with this link can view the latest version of your CV."})]}),e.jsx(B,{children:e.jsx(m,{onClick:()=>w(!1),children:"Done"})})]})})]})}export{ts as default};
